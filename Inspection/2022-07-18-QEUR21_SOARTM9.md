---
title: QEUR21_SOARTM9 – RTマルチ法(SOART法)による外観自動検査法
date: 2022-07-18
tags: ["QEUシステム", "メトリックス", "Python言語", "機械学習", "マハラノビス距離", "DX", "Blender", "SOART法", "異常判別"]
excerpt: Python言語とSOART法を使った異常判別
---

## QEUR21_SOARTM9 – RTマルチ法(SOART法)による外観自動検査法

### 【０００１】
本発明はRTマルチ法を改造して、外観検査の自動化に使用した方法に関するものです。以下、本発明の名称をSOART法と称します。

### 【背景技術】
### 【０００２】
AOI(Automatic Optical Inspection)機はPCBなどの「転写性の高い製品」の外観検査に普及しています。その主要な考え方は標準と計測画像を比較し、差異を検出することです(図１)。

**(図1：画像比較による欠陥検出)**

![imageRL3-30-1](/2022-07-18-QEUR21_SOARTM9/imageRL3-30-1.jpg)

### 【０００３】
一方、タグチメソッドのＭＴＳ(マハラノビス・タグチ・システム)は従来のＡＯＩ機では検出できない特殊な不良事象の検査に適用されています（図2）。その考え方は、良品情報群のパターン情報を「単位空間」として分散共分散行列を計算し、単位空間からの距離を計測します。その距離をしきい値を比較し、異常の判定をします（図3）。MTSは単に数値処理の枠組みであり、外観検査に適用するための「特徴量エンジニアリング(Feature-Engineering)」の手法は特別には提案されていません。
 

**(図2: マハラノビス・タグチ・システム)**

![imageRL3-30-2](/2022-07-18-QEUR21_SOARTM9/imageRL3-30-2.jpg)

**(図3: マハラノビス距離の定義)**

![imageRL3-30-3](/2022-07-18-QEUR21_SOARTM9/imageRL3-30-3.jpg)

### 【０００４】
近年のディープラーニング技術の進歩により、画像判別の精度が飛躍的に向上してきました。その中でも、CNN（畳み込みニューラルネットワーク）は有力な手法とされています。しかし、**CNNは計算量が膨大で、学習コストも高い手法**です。自動運転などの汎用用途であればともかく、工場の特定の製品に対応したシステムに使用するにはコストとメリットが釣り合わないケースが多いと思われます。

**(図4:畳み込みニューラルネットワーク,CNN)**

![imageRL3-30-4](/2022-07-18-QEUR21_SOARTM9/imageRL3-30-4.jpg)

### 【発明の概要】
### 【発明が解決しようとする課題】

### 【０００５】
多くのAOI機では光源には非常に厳格な管理をしています。光源を厳密に管理しないと、異常判定に必要な高精度の2D、3D情報を得られないためです (図5)。

**(図5: 自動外観検査技術)**

![imageRL3-30-5](/2022-07-18-QEUR21_SOARTM9/imageRL3-30-5.jpg)

### 【０００６】
しかし、製造現場の人間によって行われる外観検査はそれほど厳密に管理されたものではありません。技術上、コスト上、もしくはその他の制約により、ほとんどの製品は精密に固定し光源を管理することができません。その一例として、ワイヤーハーネスを示します(図6)。


**(図6:ワイヤーハーネス)**

![imageRL3-30-6](/2022-07-18-QEUR21_SOARTM9/imageRL3-30-6.jpg)

### 【０００７】
外観検査で検出されるべき不良事象のモードは極めて多く、それを検出するための検査ノウハウは異なります。そのため、現場で、現物を使って自動検査システムを学習させることは時間とコストが非常に多くかかります。

### 【０００８】
しかし、検査作業は製品に価値を付加しないプロセスなので、経営的には可能な限りのコストダウンが必要です。ほとんどの自動機械は1980年代に開発されたプリセット型のPLC(programable logic controller)を使っているので、それに相当する計算機で検査できるのが最適です。図7は、2020年現在に産業界で広く普及しているワンボードコンピュータであるRaspberry PiやArduinoで作った市販PLCの例です。


**(図7:ワンボードPCを使ったPLCの事例)**

![imageRL3-30-7](/2022-07-18-QEUR21_SOARTM9/imageRL3-30-7.jpg)

### 【０００９】
ワンボードコンピューターは安価だけでなく低消費電力でもあるため、自動検査に適用できればコストダウンが可能です。

### 【課題を解決するための手段】

### 【００１０】
SOART法ではタグチメソッドの一つであるRTマルチ法を改造し、畳み込みRT法とマハラノビス距離を併用して特徴量を計算します。ここで、RT法は多変量分析において、標準ベクトル量と計測ベクトル量を比較して、画像の回転量を示す感度とひずみを示すSN比という２つのメトリックスを出力します（図8）。図９にSOART法のフロー図をしめします。


**(図8:RTメトリックスの考え方)**

![imageRL3-30-8](/2022-07-18-QEUR21_SOARTM9/imageRL3-30-8.jpg)

**(図9:SOART法の計算フロー図)**

![imageRL3-30-9](/2022-07-18-QEUR21_SOARTM9/imageRL3-30-9.jpg)

### 【００１１】
**SOART法のSN比はマンハッタン距離を使っています**。従来のRT法ではユーグリッド距離を使っています。コンピュータプログラムを使う場合、マンハッタン距離とユーグリッド距離を使ってもプログラミングの手間や計算時間は同じですし、認識精度はマンハッタン距離の方が高くなります。ユーグリッド距離はデータの二乗和を使っているので少数の大きな値があると、それにメトリックスが引っ張られます。一方、マンハッタン距離は絶対値和を使用しているので、小さな値をもつ特徴量に対してもメトリックスが反応します。


**(図10 :マンハッタン距離の考え方)**

![imageRL3-30-10](/2022-07-18-QEUR21_SOARTM9/imageRL3-30-10.jpg)

### 【００１２】
SOART法のRTメトリックス計算の第1段階では**感度の代わりに「データ体積比」を出力します**。これは材料力学の考え方を導入しています。標準ベクトルと計測ベクトルを比較したときに得られた差異を全ひずみとした場合、全ひずみは「体積が変化するひずみ（体積比）」と「体積が変化しないひずみ（せん断ひずみ）」に分けることができるのです。


**(図11: 材料力学におけるひずみの分解)**

![imageRL3-30-11](/2022-07-18-QEUR21_SOARTM9/imageRL3-30-11.jpg)

### 【００１３】
画像データにおいて体積比が変わるときは、**「色（明るさ）が変わる場合」**と**「（図形の）大きさが変わる場合」**があります（図12）。事例実験の結果を図13に示します。

**(図12:データの体積比の変化)**

![imageRL3-30-12](/2022-07-18-QEUR21_SOARTM9/imageRL3-30-12.jpg)

**(図13:事例研究の結果)**

![imageRL3-30-13](/2022-07-18-QEUR21_SOARTM9/imageRL3-30-13.jpg)

### 【００１４】
RTメトリックス計算の第2段階では**畳み込み**を使用します。ここで、畳み込みにはユーザーが任意に採用した部品を適用します。ここでは、**ベンド系（4種）、ライン系（2種）、データム系（2種）**を定義しました（図14、図15）。データム系の部品は合成して使用します。

**(図14:畳み込み部品-ベンド系)**

![imageRL3-30-14](/2022-07-18-QEUR21_SOARTM9/imageRL3-30-14.jpg)

**(図15: 畳み込み部品-ライン系、データム系)**

![imageRL3-30-15](/2022-07-18-QEUR21_SOARTM9/imageRL3-30-15.jpg)

### 【００１５】
RTマルチ法は、画像（データ）をサブデータに分割し、各々のサブデータから下位のRTメトリックスを計算し、それらのメトリックスを再度統合して上位のRTメトリックスを算出する手法です（図16）。

**(図16:マルチ法)**

![imageRL3-30-16](/2022-07-18-QEUR21_SOARTM9/imageRL3-30-16.jpg)

### 【００１６】
**従来のRTマルチ法の考え方には本質的な問題があります。RT法で出力される感度メトリックスは画像の回転を示します。分割したサブ画像Aの感度（回転量）と同様に分割した画像Bの感度は必然的に同じ大きさになります。つまり、画像におけるマルチ法のメトリックスには無駄があるのです**。そこで、下位RTメトリックスの計算において、感度メトリックスの代わりに画像の明るさと大きさに反応する体積比メトリックスを採用しました。

### 【実施例_1】

### 【００１４】
本事例では、ワイヤハーネスにおけるコネクタの端子検査の場合（図17）を実験します。実物試験のかわりに、広く普及している**3DレンダリングソフトウェアであるBlender**を使いました（図18）。

**（図17： コネクタの端子検査)**

![imageRL3-30-17](/2022-07-18-QEUR21_SOARTM9/imageRL3-30-17.jpg)

**（図18： Blenderのワークスペース)**

![imageRL3-30-18](/2022-07-18-QEUR21_SOARTM9/imageRL3-30-18.jpg)

### 【００１７】
コネクタは縦3個x横9個のPINつきの製品とし、ピンの番号を図19のように定義しました。標準情報はライトの明るさのみを変更した20枚の画像の平均値としました。第1段階のRTメトリックスの計算において、ライトの明るさ、ワークの回転と移動を加えた50枚の画像を単位空間としました。体積比をY2、SN比をY3として散布図を表示した場合の分布を図20に示します。


**（図19 ：ピン番号と標準画像）**

![imageRL3-30-19](/2022-07-18-QEUR21_SOARTM9/imageRL3-30-19.jpg)

**（図20 ：体積比（Y2）とSN比（Y3）の関係）**

![imageRL3-30-20](/2022-07-18-QEUR21_SOARTM9/imageRL3-30-20.jpg)

### 【００１８】
上図によると、Y2-Y3メトリックスの分布形状は複雑であり、2次元マハラノビス距離が仮定するような単純な楕円型分布ではありません。しかし、マハラノビス距離を使用すれば、明るさ（Y2）によるノイズをある程度は補正できそうです。そこで、マハラノビス距離を計算するために分散共分散行列をピン毎に計算し、グラフ化しました（図21）。

**（図21：各ピンの分散、共分散の変動）**

![imageRL3-30-21](/2022-07-18-QEUR21_SOARTM9/imageRL3-30-21.jpg)

### 【００１９】
あるピンにおけるマハラノビス距離の分布をヒートマップで画像化した事例を図22に示します。ここで、下位マハラノビス距離を計算とき、計測対象が正値で背景が0に近い値に補正されています。図中の右ピンと左ピンの背景の値が大きく違うのは、ピン毎に使用している単位空間が違うためであり、実際に使用する値は当該ピンの値だけです。

**図22：下位マハラノビス距離の分布)**

![imageRL3-30-22](/2022-07-18-QEUR21_SOARTM9/imageRL3-30-22.jpg)

### 【００２０】
第2段階の畳み込みRTメトリックスの計算後でも、同様に（上位）マハラノビス距離を計算します。ここで、単位空間は3種類（左-中央-右）としています。平均ベクトルと分散共分散行列は6次元になっていますが（図23）、それはベンド系（4次元）とライン系（2次元）の畳みこみRTメトリックスが出力されるためです。


**(図23：平均ベクトルと分散共分散行列)**

![imageRL3-30-23](/2022-07-18-QEUR21_SOARTM9/imageRL3-30-23.jpg)

### 【００２１】
以上の学習の完了後、任意の画像を入力すると特徴量マップが出力されます。特徴量マップでは**各ピンの感度とSN比から、それぞれマハラノビス距離を計算しました**。良品のコネクタの特徴量マップを図24と図25に示します。


**（図24：良品の特徴量マップ、移動量がマイナス）**

![imageRL3-30-24](/2022-07-18-QEUR21_SOARTM9/imageRL3-30-24.jpg)

**（図25：良品の特徴量マップ、移動量がプラス）**

![imageRL3-30-25](/2022-07-18-QEUR21_SOARTM9/imageRL3-30-25.jpg)

### 【００２２】
上図より**特徴量マップの感度の挙動はワークの移動に相関する**ことがわかります。一方、SN比はワークの移動に影響されません。つまり、SOART法ではマルチ法を適応することによりライトの明るさやワークの回転や移動の影響を排除し、その結果、SN比はワークの異常度のみを検出していることがわかります。

### 【００２３】
次に、ピンが倒れて不良になった場合に検出できるかを実験してみましょう。図26にはピンアドレスが3-1の場合と、図27にはアドレス4-1で異常が発生した場合を示します。SN比の分布を見ると、不良が発生しているPINアドレスでマハラノビス距離値が高くなっています。


**（図26：不良品、PINアドレスが3-1の場合）**

![imageRL3-30-26](/2022-07-18-QEUR21_SOARTM9/imageRL3-30-26.jpg)

**（図27：不良品、PINアドレスが4-1の場合）**

![imageRL3-30-27](/2022-07-18-QEUR21_SOARTM9/imageRL3-30-27.jpg)

### 【００２４】
ただし、ワークが回転すると角部で感度が高くなり、SN比も高くなります。このときシステムが正しく異常を判定するには、SVM（サポートベクトルマシン）などで学習するか、ユーザーが過検出を受け入れる必要があります。もちろん、ワークを保持する治具精度を上げて回転を抑えるのがもっとも理想的でしょう。

### 【００２５】
最後に、端子が垂直方向に後退した不良モードの場合の特徴量マップをしめします。一枚の画像では端子後退を検出することは、原則的に不可能です。ただし、角度によっては検出できる場合があります。

**（図28：特徴量マップ、PINアドレス3-1で不良、検出できず）**

![imageRL3-30-28](/2022-07-18-QEUR21_SOARTM9/imageRL3-30-28.jpg)

**（図29：特徴量マップ、PINアドレス3-1で不良、検出できた）**

![imageRL3-30-29](/2022-07-18-QEUR21_SOARTM9/imageRL3-30-29.jpg)

### 【００２６】
**もしも奥行きを計測する場合にはRT両目法を採用するためにカメラを増設する必要があります（図30）**。

**（図30：RT両目法のフロー図）**

![imageRL3-30-30](/2022-07-18-QEUR21_SOARTM9/imageRL3-30-30.jpg)

### 【産業上の利用可能性】

### 【００２７】
SOART法は精密さを必要としない、比較的簡単な外観検査全般に使用することができます。従来の手法よりも、ハードウェアのスペック要求レベルが低く、必要な学習データ量がすくなくなります。そのため、従来の手法よりも導入コストが著しく安くなります。

### 【００２８】
さらに、SOART法はメトリックスを使用して判別をしているために抽象化が可能です。つまり、現物のかわりに**デジタル・ツインを使用しても、かなり高い精度の学習ができます**（図31）。

**（図31： Digital Twinの考え方）**

![imageRL3-30-31](/2022-07-18-QEUR21_SOARTM9/imageRL3-30-31.jpg)

### 【００２９】
非常に簡単なシステムで製品異常を検出しているので、場合によっては検出精度が若干低くなる可能性があります。ただし、人間による目視検査の信頼性がそれほど高くない（図32）ので、導入コストとのバランスを勘案して導入を決定する必要があるでしょう。

**（図32： 人間による外観検査のパフォーマンス）**

![imageRL3-30-32](/2022-07-18-QEUR21_SOARTM9/imageRL3-30-32.jpg)

### 【補足】
### 【００３０】
SOART法は**The state of art Recognition Taguchi法（RT法の最新版）の略称**です。タグチメソッドの一つであるRT法がアイデアの元にはなっていますが、すでにタグチメソッドから離れている概念が多いため、**タグチメソッドとは異なる手法と考えるべき**と思います。


## ～　まとめ　～

D先生 : “今回のSOART法による外観検査自動機の開発が、QEUシステムの最高峰でした・・・。”

QEU:FOUNDER ： “まだQEUロボティックスのシリーズはつづくが、これ以上の成果は出てこないでしょう。**生産力を上げるため**に活用してほしいです。”

![imageRL3-30-33](/2022-07-18-QEUR21_SOARTM9/imageRL3-30-33.jpg)

D先生 : “今回は、FOUNDERがまたもやこの話をしたいと・・・。いやいや・・・、酷い話で・・・。”

![imageRL3-30-34](/2022-07-18-QEUR21_SOARTM9/imageRL3-30-34.jpg)

QEU:FOUNDER ： “いやいや、話のポイントはちょっとずれています。久々に、この話をしようと・・・（笑）。**2020年末から、200年周期の「風の時代」に移行した**でしょ？それを検証したい・・・。”

![imageRL3-30-35](/2022-07-18-QEUR21_SOARTM9/imageRL3-30-35.jpg)

QEU:FOUNDER ： “**風の時代とは価値観の変化の時代と言われています。**”

![imageRL3-30-36](/2022-07-18-QEUR21_SOARTM9/imageRL3-30-36.jpg)

QEU:FOUNDER ： “・・・というわけで、統計をとってみました。**お友達**の星座は・・・？”

![imageRL3-30-37](/2022-07-18-QEUR21_SOARTM9/imageRL3-30-37.jpg)

C部長 : “えっ？で・・・、結果は？”

![imageRL3-30-38](/2022-07-18-QEUR21_SOARTM9/imageRL3-30-38.jpg)

QEU:FOUNDER ： “集計の結果（↑）をドン！！**茶色のシンボルは2020年以前の「土の時代」の星座です。そして、緑のシンボルは「風の時代」の星座です**。占星術って統計学と言われますが、結構おもしろいでしょ？”

C部長 : “じゃあ、我らがイケメンは・・・！？”

![imageRL3-30-39](/2022-07-18-QEUR21_SOARTM9/imageRL3-30-39.jpg)

QEU:FOUNDER ： “残念・・・。外れです。”

D先生 : “では、私のイケメンは？”

![imageRL3-30-40](/2022-07-18-QEUR21_SOARTM9/imageRL3-30-40.jpg)

QEU:FOUNDER ： “なんと、大当たり！！・・・ちなみに、この人も大当たりです（笑）。”

![imageRL3-30-41](/2022-07-18-QEUR21_SOARTM9/imageRL3-30-41.jpg)

C部長 : “これからはO阪の時代といえます（笑）。”
